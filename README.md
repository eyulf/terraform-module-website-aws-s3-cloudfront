# Terraform AWS S3/Cloudfront Website

## Contents
- [Introduction](#introduction)
- [Usage](#usage)
- [Requirements](#requirements)
- [Providers](#providers)
- [Modules](#modules)
- [Resources](#resources)
- [Inputs](#inputs)
- [Outputs](#outputs)

## Introduction

This module will configure multiple S3 buckets with website hosting enabled. By default, an IAM user is also created and optionally configured with an intial access key to provide an easy way to upload website files to the S3 buckets.

A S3 bucket and Cloudfront distribution is created for the provided domain and by default a S3 bucket and Cloudfront distribution is also created to redirects to this.

Cloudfront is configured to serve SSL certificates that are generated by ACM. A Lambda application[1] is also provisioned to work around limitations[2] with Cloudfront's Origin Access Identity and S3 website hosting.

For DNS hosting, you can supply either a Cloudflare or Route53 zone ID. DNS records will be created in either service where this is supplied. The zone itself is not created or managed by this module.

1. https://github.com/digital-sailors/standard-redirects-for-cloudfront
1. https://aws.amazon.com/blogs/compute/implementing-default-directory-indexes-in-amazon-s3-backed-amazon-cloudfront-origins-using-lambdaedge/

## Usage

### Default (Cloudflare)
```hcl
module "website-aws-s3-cloudfront-cloudflare" {
  source             = "eyulf/website-aws-s3-cloudfront/module"
  version            = "1.0.0"
  website_domain     = "example.com"
  cloudflare_zone_id = <CLOUDFLARE ZONE ID>
}
```

### Default (Route53)
```hcl
module "website-aws-s3-cloudfront-route53" {
  source          = "eyulf/website-aws-s3-cloudfront/module"
  version         = "1.0.0"
  website_domain  = "example.com"
  route53_zone_id = <ROUTE53 ZONE ID>
}
```

---

<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
Provider Configuration

## Requirements

| Name | Version |
|------|---------|
| terraform | >= 0.13.0 |
| aws | ~> 3.0 |
| cloudflare | ~> 2.0 |

## Providers

| Name | Version |
|------|---------|
| aws | ~> 3.0 |
| aws.virginia | ~> 3.0 |
| cloudflare | ~> 2.0 |

## Modules

No Modules.

## Resources

| Name |
|------|
| [aws_acm_certificate_validation](https://registry.terraform.io/providers/hashicorp/aws/3.0/docs/resources/acm_certificate_validation) |
| [aws_acm_certificate](https://registry.terraform.io/providers/hashicorp/aws/3.0/docs/resources/acm_certificate) |
| [aws_cloudfront_distribution](https://registry.terraform.io/providers/hashicorp/aws/3.0/docs/resources/cloudfront_distribution) |
| [aws_cloudfront_origin_access_identity](https://registry.terraform.io/providers/hashicorp/aws/3.0/docs/resources/cloudfront_origin_access_identity) |
| [aws_iam_access_key](https://registry.terraform.io/providers/hashicorp/aws/3.0/docs/resources/iam_access_key) |
| [aws_iam_group](https://registry.terraform.io/providers/hashicorp/aws/3.0/docs/data-sources/iam_group) |
| [aws_iam_group](https://registry.terraform.io/providers/hashicorp/aws/3.0/docs/resources/iam_group) |
| [aws_iam_policy_document](https://registry.terraform.io/providers/hashicorp/aws/3.0/docs/data-sources/iam_policy_document) |
| [aws_iam_user_group_membership](https://registry.terraform.io/providers/hashicorp/aws/3.0/docs/resources/iam_user_group_membership) |
| [aws_iam_user_policy](https://registry.terraform.io/providers/hashicorp/aws/3.0/docs/resources/iam_user_policy) |
| [aws_iam_user](https://registry.terraform.io/providers/hashicorp/aws/3.0/docs/resources/iam_user) |
| [aws_route53_record](https://registry.terraform.io/providers/hashicorp/aws/3.0/docs/resources/route53_record) |
| [aws_s3_bucket_policy](https://registry.terraform.io/providers/hashicorp/aws/3.0/docs/resources/s3_bucket_policy) |
| [aws_s3_bucket](https://registry.terraform.io/providers/hashicorp/aws/3.0/docs/resources/s3_bucket) |
| [aws_serverlessapplicationrepository_application](https://registry.terraform.io/providers/hashicorp/aws/3.0/docs/data-sources/serverlessapplicationrepository_application) |
| [aws_serverlessapplicationrepository_cloudformation_stack](https://registry.terraform.io/providers/hashicorp/aws/3.0/docs/resources/serverlessapplicationrepository_cloudformation_stack) |
| [cloudflare_record](https://registry.terraform.io/providers/cloudflare/cloudflare/2.0/docs/resources/record) |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| cloudflare\_zone\_id | The Cloudflare Zone ID. Not Required if `route53_zoneid` is provided. | `string` | `""` | no |
| cloudfront\_default\_cache\_allowed\_methods | List of allowed methods for the Cloudfront default cache behaviour configuration. | `list(string)` | <pre>[<br>  "GET",<br>  "HEAD"<br>]</pre> | no |
| cloudfront\_default\_cache\_cached\_methods | List of cached\_methods for the Cloudfront default cache behaviour configuration. | `list(string)` | <pre>[<br>  "GET",<br>  "HEAD"<br>]</pre> | no |
| cloudfront\_default\_cache\_default\_ttl | The default ttl value for the Cloudfront default cache behaviour configuration. | `number` | `3600` | no |
| cloudfront\_default\_cache\_max\_ttl | The maximum ttl value for the Cloudfront default cache behaviour configuration. | `number` | `86400` | no |
| cloudfront\_default\_cache\_min\_ttl | The minimum ttl value for the Cloudfront default cache behaviour configuration. | `number` | `0` | no |
| cloudfront\_price\_class | The price class to use for Cloudfront. Must be one of `PriceClass_All`, `PriceClass_200` or `PriceClass_100`. | `string` | `"PriceClass_All"` | no |
| cloudfront\_ssl\_minimum\_protocol | The minimum SSL protocol to use for the Cloudfront viewer certificate configuration. | `string` | `"TLSv1.2_2019"` | no |
| iam\_group\_create | When set to `true` this will create and manage the IAM group. When set to `false` it will use a data resource instead. | `bool` | `true` | no |
| iam\_group\_name | The name of the IAM group that the IAM user will be added to. | `string` | `"s3_uploaders"` | no |
| iam\_user\_create | When set to `true` this will create and manage the IAM user. | `bool` | `true` | no |
| iam\_user\_keys\_create | When set to `true` this will create and output the Access Key ID and Secret Access Keys for the IAM user. | `bool` | `false` | no |
| iam\_user\_path | The path used for the IAM user. | `string` | `"/websites/"` | no |
| iam\_user\_prefix\_name | The prefix used at the beginning of the IAM user's name. | `string` | `"s3_uploader"` | no |
| route53\_zone\_id | The Route53 Zone ID. Not Required if `cloudflare_zone_id` is provided. | `string` | `""` | no |
| s3\_cors\_allowed\_headers | List of allowed headers for the S3 Bucket's CORS configuration. | `list(string)` | `[]` | no |
| s3\_cors\_allowed\_methods | List of allowed methods for the S3 Bucket's CORS configuration. | `list(string)` | <pre>[<br>  "GET"<br>]</pre> | no |
| s3\_cors\_allowed\_origins | List of allowed origins for the S3 Bucket's CORS configuration. | `list(string)` | `[]` | no |
| s3\_cors\_expose\_headers | List of expose headers for the S3 Bucket's CORS configuration. | `list(string)` | `[]` | no |
| s3\_lifecycle\_noncurrent\_expiration | The number of days after which a non current version of a S3 object will be expired. | `number` | `30` | no |
| website\_domain | The primary domain name to use for the website. | `string` | n/a | yes |
| website\_redirect\_www | When set to `true` this will create a s3 bucket and cloudfront distribution to redirect www.`website_domain` to `website_domain`. | `bool` | `true` | no |

## Outputs

| Name | Description |
|------|-------------|
| cloudfront\_url | The name of the Cloudfront URL. |
| cloudfront\_url\_redirect | The name of the Cloudfront URL providing redirects. |
| iam\_user\_access\_key\_id | The Access Key ID of the IAM user used for uploading to the S3 bucket |
| iam\_user\_secret\_access\_key | The Secret Access Key of the IAM user used for uploading to the S3 bucket |
| s3\_bucket | The name of the S3 Bucket. |
<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
